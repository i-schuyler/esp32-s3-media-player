name: Codex Issue to PR

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  draft-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

- name: Comment 'Codex started…' on issue
  uses: actions/github-script@v7
  with:
    github-token: ${{ github.token }}
    script: |
      // For issue_comment events, only proceed if the comment is exactly "/retry"
      if (context.eventName === 'issue_comment') {
        const body = ((context.payload.comment && context.payload.comment.body) || '').trim();
        if (body !== '/retry') {
          core.info(`Ignoring issue_comment body: ${body}`);
          return;
        }
      }

      const issueNumber = context.payload.issue.number;
      const owner = context.repo.owner;
      const repo = context.repo.repo;

      await github.rest.issues.createComment({
        owner,
        repo,
        issue_number: issueNumber,
        body: 'Codex started…',
      });


      # Codex creates a PR implementing the issue with minimal, test-gated changes.
      - name: Codex draft PR from issue
        if: |
          github.event_name == 'issues' ||
          (github.event_name == 'issue_comment' && github.event.comment.body == '/retry') ||
          github.event_name == 'workflow_dispatch'
        uses: openai/codex-action@v1
        with:
          # Keep the agent focused and safe.
          # It should:
          # - create a slice plan in the PR body
          # - implement minimal changes
          # - follow the PR template fields (RISK/BREAKING/NEEDS_HIL)
          prompt: |
            You are an automation agent for this repository.
            Read the newly opened GitHub Issue (title + body) and do the following:

            1) Convert it into an implementation plan that references ACCEPTANCE.md and docs/SMOKE_TEST_SPEC.md.
            2) Implement only the minimum necessary code/docs to satisfy the request.
               - No refactors unless required.
               - No unrelated features.
            3) Open a pull request with:
               - A link to the Issue URL
               - A short Scope section
               - RISK: low|med|high (choose conservatively)
               - BREAKING: no unless absolutely required
               - NEEDS_HIL: no (until a HIL runner exists)
            4) Ensure the PR will pass policy-gates in CI.

            If you cannot safely implement without more info, open a PR that adds a clarifying question to the Issue as a comment
            and include a minimal "investigation" change (docs only), with RISK: low and NEEDS_HIL: no.

          openai_api_key: ${{ secrets.OPENAI_API_KEY }}

- name: Find created PR and comment on the issue
  if: always()
  uses: actions/github-script@v7
  with:
    github-token: ${{ github.token }}
    script: |
      const issueNumber = context.payload.issue.number;
      const owner = context.repo.owner;
      const repo = context.repo.repo;

      // Search open PRs that mention this issue (by full URL first, then "#<num>").
      const qUrl = `repo:${owner}/${repo} is:pr is:open ${context.payload.issue.html_url}`;
      const qHash = `repo:${owner}/${repo} is:pr is:open (#${issueNumber})`;

      async function search(q) {
        return await github.rest.search.issuesAndPullRequests({ q, per_page: 5 });
      }

      let results = await search(qUrl);
      if (!results.data.items.length) results = await search(qHash);

      if (!results.data.items.length) {
        await github.rest.issues.createComment({
          owner, repo, issue_number: issueNumber,
          body: `Codex workflow ran, but I couldn't find an open PR referencing this issue yet. Check Actions logs for details.`,
        });
        return;
      }

      const pr = results.data.items.sort((a,b)=> new Date(b.updated_at)-new Date(a.updated_at))[0];
      await github.rest.issues.createComment({
        owner, repo, issue_number: issueNumber,
        body: `PR created: ${pr.html_url}`,
      });
